---
import type { HTMLAttributes } from 'astro/types';
import { DATA_LAST_UPDATED, FEEDBACK_URL, SITE_NAME, SITE_URL } from '../lib/site';
import Analytics from '../components/Analytics.astro';
import ChatWidget from '../components/ChatWidget';

interface Props extends HTMLAttributes<'html'> {
  title: string;
  description: string;
  image?: string;
  noindex?: boolean;
  dataLastUpdated?: string;
  breadcrumbs?: { name: string; url: string }[];
}

const {
  title,
  description,
  image = '/og-image.png',
  noindex = false,
  dataLastUpdated = DATA_LAST_UPDATED,
  breadcrumbs = [],
  ...attrs
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const siteTitle = `Compare Proxy Prices | 40+ Providers | ${SITE_NAME}`;
const fullTitle = title === 'Home' ? siteTitle : `${title} | ${SITE_NAME}`;

const schemaGraph: any[] = [
  {
    "@type": "Organization",
    "@id": `${SITE_URL}#organization`,
    name: SITE_NAME,
    url: SITE_URL,
  },
  {
    "@type": "WebSite",
    "@id": `${SITE_URL}#website`,
    name: SITE_NAME,
    url: SITE_URL,
    inLanguage: "en",
  },
  {
    "@type": "WebPage",
    name: fullTitle,
    url: canonicalURL.toString(),
    isPartOf: { "@id": `${SITE_URL}#website` },
  },
];

if (breadcrumbs.length >= 2) {
  const breadcrumbId = `${canonicalURL.toString()}#breadcrumb`;
  schemaGraph.push({
    "@type": "BreadcrumbList",
    "@id": breadcrumbId,
    itemListElement: breadcrumbs.map((b, index) => ({
      "@type": "ListItem",
      position: index + 1,
      name: b.name,
      item: b.url,
    })),
  });

  (schemaGraph.find((n) => n["@type"] === "WebPage") as any).breadcrumb = { "@id": breadcrumbId };
}
---

<!doctype html>
<html lang="en" {...attrs}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Global Styles -->
    <link rel="stylesheet" href="/src/styles/global.css" />
    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" sizes="any">
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

    <link rel="canonical" href={canonicalURL} />

    <!-- Preconnect for external resources -->
    <link rel="preconnect" href="https://t0.gstatic.com" />
    <link rel="dns-prefetch" href="https://t0.gstatic.com" />

    <title>{fullTitle}</title>
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.site)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.site)} />

    {noindex && <meta name="robots" content="noindex,nofollow" />}

    <meta name="generator" content={Astro.generator} />
	    <script is:inline
	      type="application/ld+json"
	      set:html={JSON.stringify({
	        "@context": "https://schema.org",
	        "@graph": schemaGraph,
	      })}
	    />

    <style is:global>
      :root {
        --color-primary: #3b82f6;
        --color-primary-dark: #2563eb;
        --color-secondary: #10b981;
        --color-accent: #f59e0b;
        --color-text: #1f2937;
        --color-text-light: #6b7280;
        --color-bg: #ffffff;
        --color-bg-alt: #f9fafb;
        --color-border: #e5e7eb;
        --max-width: 1280px;
        --spacing: 1rem;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --color-text: #f9fafb;
          --color-text-light: #d1d5db;
          --color-bg: #111827;
          --color-bg-alt: #1f2937;
          --color-border: #374151;
        }
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: var(--color-bg);
        color: var(--color-text);
        line-height: 1.6;
      }

      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      main {
        flex: 1;
      }

      h1, h2, h3, h4, h5, h6 {
        line-height: 1.2;
        font-weight: 700;
      }

      h1 { font-size: 2.5rem; }
      h2 { font-size: 2rem; }
      h3 { font-size: 1.5rem; }

      a {
        color: var(--color-primary);
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      button {
        cursor: pointer;
        font-family: inherit;
      }

      .container {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: 0 var(--spacing);
      }

      @media (max-width: 768px) {
        h1 { font-size: 2rem; }
        h2 { font-size: 1.75rem; }
        h3 { font-size: 1.25rem; }
      }
    </style>
  </head>
  <body>
    <a class="skip-link" href="#main-content">Skip to content</a>
    <header class="header">
      <nav class="container nav">
        <a href="/" class="logo">
          <span class="logo-icon">ðŸ’°</span>
          <span class="logo-text">ProxyPrice</span>
        </a>

        <button class="mobile-menu-btn" aria-label="Toggle menu" aria-expanded="false">
          <span class="hamburger"></span>
          <span class="hamburger"></span>
          <span class="hamburger"></span>
        </button>

	        <ul class="nav-links">
	          <li><a href="/residential">Residential</a></li>
	          <li><a href="/datacenter">Datacenter</a></li>
	          <li><a href="/mobile">Mobile</a></li>
	          <li><a href="/isp">ISP</a></li>
	          <li><a href="/best">Best</a></li>
	          <li><a href="/providers">Providers</a></li>
	          <li><a href="/calculator" class="nav-cta">Calculator</a></li>
	        </ul>
      </nav>
    </header>

    <main id="main-content">
      <slot />
    </main>

    <footer class="footer">
      <div class="container footer-content">
        <div class="footer-section">
          <h4>ProxyPrice</h4>
          <p>The definitive proxy price comparison platform. Compare 40+ providers and find the best deal for your needs.</p>
        </div>
        <div class="footer-section">
          <h4>Proxy Types</h4>
          <ul>
            <li><a href="/residential">Residential Proxies</a></li>
            <li><a href="/datacenter">Datacenter Proxies</a></li>
            <li><a href="/mobile">Mobile Proxies</a></li>
            <li><a href="/isp">ISP Proxies</a></li>
          </ul>
        </div>
	        <div class="footer-section">
	          <h4>Tools</h4>
	          <ul>
	            <li><a href="/calculator">Price Calculator</a></li>
	            <li><a href="/best">Best Providers</a></li>
	            <li><a href="/providers">All Providers</a></li>
	          </ul>
	        </div>
	        <div class="footer-section">
	          <h4>Resources</h4>
	          <ul>
	            <li><a href="/features">Features</a></li>
	            <li><a href="/use-cases">Use Cases</a></li>
	            <li><a href="/pricing">Pricing Tiers</a></li>
	            <li><a href="/methodology">Methodology</a></li>
	            {FEEDBACK_URL && <li><a href={FEEDBACK_URL}>Report a Correction</a></li>}
	          </ul>
	        </div>
	      </div>
      <div class="container footer-bottom">
        <p class="disclosure">
          <strong>Affiliate Disclosure:</strong> Some links on this website are affiliate links. If you make a purchase through these links, we may earn a commission at no additional cost to you. This helps support our work and allows us to continue providing unbiased comparisons.
        </p>
        <p>&copy; {new Date().getFullYear()} {SITE_NAME}. Data updated {dataLastUpdated}.</p>
      </div>
    </footer>

    <style>
      .skip-link {
        position: absolute;
        left: -9999px;
        top: 0;
        background: var(--color-bg);
        color: var(--color-text);
        border: 1px solid var(--color-border);
        padding: 0.5rem 0.75rem;
        border-radius: 0.375rem;
        z-index: 200;
      }

      .skip-link:focus {
        left: 1rem;
        top: 1rem;
      }

      .header {
        background: var(--color-bg);
        border-bottom: 1px solid var(--color-border);
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(10px);
      }

      .nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-text);
        text-decoration: none;
      }

      .logo:hover {
        text-decoration: none;
      }

      .logo-icon {
        font-size: 1.75rem;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
        list-style: none;
        align-items: center;
      }

      .nav-links a {
        color: var(--color-text);
        font-weight: 500;
        transition: color 0.2s;
      }

      .nav-links a:hover {
        color: var(--color-primary);
        text-decoration: none;
      }

      .nav-cta {
        background: var(--color-primary);
        color: white !important;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
      }

      .nav-cta:hover {
        background: var(--color-primary-dark);
      }

      /* Mobile Menu Button */
      .mobile-menu-btn {
        display: none;
      }

      .footer {
        background: var(--color-bg-alt);
        border-top: 1px solid var(--color-border);
        margin-top: 4rem;
        padding: 3rem 0 1rem;
      }

      .footer-content {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      .footer-section h4 {
        margin-bottom: 1rem;
        font-size: 1.125rem;
      }

      .footer-section ul {
        list-style: none;
      }

      .footer-section li {
        margin-bottom: 0.5rem;
      }

      .footer-section a {
        color: var(--color-text-light);
      }

      .footer-section p {
        color: var(--color-text-light);
        font-size: 0.875rem;
      }

      .footer-bottom {
        padding-top: 2rem;
        border-top: 1px solid var(--color-border);
        text-align: center;
        color: var(--color-text-light);
        font-size: 0.875rem;
      }

      .footer-bottom .disclosure {
        font-size: 0.8125rem;
        line-height: 1.5;
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--color-bg-alt);
        border-radius: 0.5rem;
        border: 1px solid var(--color-border);
      }

      .footer-bottom .disclosure strong {
        color: var(--color-text);
      }

	      @media (max-width: 768px) {
	        .mobile-menu-btn {
	          display: flex;
	          flex-direction: column;
	          justify-content: space-around;
	          width: 2rem;
	          height: 2rem;
	          background: transparent;
	          border: none;
	          cursor: pointer;
	          padding: 0;
	          z-index: 102;
	        }

	        .hamburger {
	          width: 1.75rem;
	          height: 2px;
	          background: var(--color-text);
	          border-radius: 2px;
	          transition: all 0.3s ease-in-out;
	          transform-origin: center;
	        }

	        .mobile-menu-btn[aria-expanded="true"] .hamburger:nth-child(1) {
	          transform: translateY(7px) rotate(45deg);
	        }

	        .mobile-menu-btn[aria-expanded="true"] .hamburger:nth-child(2) {
	          opacity: 0;
	        }

	        .mobile-menu-btn[aria-expanded="true"] .hamburger:nth-child(3) {
	          transform: translateY(-7px) rotate(-45deg);
	        }

	        .nav-links {
	          position: fixed;
	          top: 0;
	          right: -100%;
	          flex-direction: column;
	          align-items: center;
	          justify-content: center;
	          gap: 2rem;
	          width: 75%;
	          max-width: 300px;
	          height: 100vh;
	          background: var(--color-bg);
	          border-left: 1px solid var(--color-border);
	          box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
	          transition: right 0.3s ease-in-out;
	          padding: 5rem 0;
	          font-size: 1rem;
	        }

	        .nav-links.nav-links-open {
	          right: 0;
	        }

	        .nav-links a {
	          padding: 0.75rem 1.5rem;
	          border-radius: 0.5rem;
	        }

	        .nav-cta {
	          width: auto;
	          text-align: center;
	        }

	        .footer-content {
	          grid-template-columns: 1fr;
	          gap: 2rem;
	        }
	      }

	      @media (min-width: 769px) {
	        .mobile-menu-btn {
	          display: none;
	        }
	      }
	    </style>

	    <script is:inline>
	      const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
	      const navLinks = document.querySelector('.nav-links');

	      if (mobileMenuBtn && navLinks) {
	        mobileMenuBtn.addEventListener('click', () => {
	          const isOpen = navLinks.classList.toggle('nav-links-open');
	          mobileMenuBtn.setAttribute('aria-expanded', isOpen.toString());
	        });

	        // Close menu when clicking outside
	        document.addEventListener('click', (e) => {
	          if (!navLinks.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
	            navLinks.classList.remove('nav-links-open');
	            mobileMenuBtn.setAttribute('aria-expanded', 'false');
	          }
	        });

	        // Close menu when clicking a link
	        navLinks.querySelectorAll('a').forEach(link => {
	          link.addEventListener('click', () => {
	            navLinks.classList.remove('nav-links-open');
	            mobileMenuBtn.setAttribute('aria-expanded', 'false');
	          });
	        });

	        // Close menu on escape key
	        document.addEventListener('keydown', (e) => {
	          if (e.key === 'Escape') {
	            navLinks.classList.remove('nav-links-open');
	            mobileMenuBtn.setAttribute('aria-expanded', 'false');
	          }
	        });
	      }
	    </script>
    <!-- Privacy-Friendly Analytics -->
    <Analytics />
    <!-- AI Chat Assistant -->
    <ChatWidget client:load />
  </body>
</html>
