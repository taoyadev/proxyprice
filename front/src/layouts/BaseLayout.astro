---
import type { HTMLAttributes } from 'astro/types';
import { DATA_LAST_UPDATED, FEEDBACK_URL, SITE_NAME, SITE_URL } from '../lib/site';
import Analytics from '../components/Analytics.astro';
import ChatWidget from '../components/ChatWidget';
import "../styles/global.css";

interface Props extends HTMLAttributes<'html'> {
  title: string;
  description: string;
  image?: string;
  noindex?: boolean;
  dataLastUpdated?: string;
  breadcrumbs?: { name: string; url: string }[];
}

const {
  title,
  description,
  image = '/og-image.png',
  noindex = false,
  dataLastUpdated = DATA_LAST_UPDATED,
  breadcrumbs = [],
  ...attrs
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const siteTitle = `Compare Proxy Prices | 40+ Providers | ${SITE_NAME}`;
const fullTitle = title === 'Home' ? siteTitle : `${title} | ${SITE_NAME}`;

const schemaGraph: any[] = [
  {
    "@type": "Organization",
    "@id": `${SITE_URL}#organization`,
    name: SITE_NAME,
    url: SITE_URL,
  },
  {
    "@type": "WebSite",
    "@id": `${SITE_URL}#website`,
    name: SITE_NAME,
    url: SITE_URL,
    inLanguage: "en",
  },
  {
    "@type": "WebPage",
    name: fullTitle,
    url: canonicalURL.toString(),
    isPartOf: { "@id": `${SITE_URL}#website` },
  },
];

if (breadcrumbs.length >= 2) {
  const breadcrumbId = `${canonicalURL.toString()}#breadcrumb`;
  schemaGraph.push({
    "@type": "BreadcrumbList",
    "@id": breadcrumbId,
    itemListElement: breadcrumbs.map((b, index) => ({
      "@type": "ListItem",
      position: index + 1,
      name: b.name,
      item: b.url,
    })),
  });

  (schemaGraph.find((n) => n["@type"] === "WebPage") as any).breadcrumb = { "@id": breadcrumbId };
}
---

<!doctype html>
<html lang="en" {...attrs}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles -->
    <link rel="stylesheet" href="/styles/base-layout.css" />
    <!-- Favicon -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" sizes="any">
    <link rel="icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">

    <link rel="canonical" href={canonicalURL} />

    <!-- Preconnect for external resources -->
    <link rel="preconnect" href="https://t0.gstatic.com" />
    <link rel="dns-prefetch" href="https://t0.gstatic.com" />

    <title>{fullTitle}</title>
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.site)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.site)} />

    {noindex && <meta name="robots" content="noindex,nofollow" />}

    <meta name="generator" content={Astro.generator} />
	    <script is:inline
	      type="application/ld+json"
	      set:html={JSON.stringify({
	        "@context": "https://schema.org",
	        "@graph": schemaGraph,
	      })}
	    />

  </head>
  <body>
    <a class="skip-link" href="#main-content">Skip to content</a>
    <header class="header">
      <nav class="container nav">
        <a href="/" class="logo">
          <span class="logo-icon">ðŸ’°</span>
          <span class="logo-text">ProxyPrice</span>
        </a>

        <button class="mobile-menu-btn" aria-label="Toggle menu" aria-expanded="false">
          <span class="hamburger"></span>
          <span class="hamburger"></span>
          <span class="hamburger"></span>
        </button>

	        <ul class="nav-links">
	          <li><a href="/residential">Residential</a></li>
	          <li><a href="/datacenter">Datacenter</a></li>
	          <li><a href="/mobile">Mobile</a></li>
	          <li><a href="/isp">ISP</a></li>
	          <li><a href="/best">Best</a></li>
	          <li><a href="/providers">Providers</a></li>
	          <li><a href="/calculator" class="nav-cta">Calculator</a></li>
	        </ul>
      </nav>
    </header>

    <main id="main-content">
      <slot />
    </main>

    <footer class="footer">
      <div class="container footer-content">
        <div class="footer-section">
          <h4>ProxyPrice</h4>
          <p>The definitive proxy price comparison platform. Compare 40+ providers and find the best deal for your needs.</p>
        </div>
        <div class="footer-section">
          <h4>Proxy Types</h4>
          <ul>
            <li><a href="/residential">Residential Proxies</a></li>
            <li><a href="/datacenter">Datacenter Proxies</a></li>
            <li><a href="/mobile">Mobile Proxies</a></li>
            <li><a href="/isp">ISP Proxies</a></li>
          </ul>
        </div>
	        <div class="footer-section">
	          <h4>Tools</h4>
	          <ul>
	            <li><a href="/calculator">Price Calculator</a></li>
	            <li><a href="/best">Best Providers</a></li>
	            <li><a href="/providers">All Providers</a></li>
	          </ul>
	        </div>
	        <div class="footer-section">
	          <h4>Resources</h4>
	          <ul>
	            <li><a href="/features">Features</a></li>
	            <li><a href="/use-cases">Use Cases</a></li>
	            <li><a href="/pricing">Pricing Tiers</a></li>
	            <li><a href="/methodology">Methodology</a></li>
	            {FEEDBACK_URL && <li><a href={FEEDBACK_URL}>Report a Correction</a></li>}
	          </ul>
	        </div>
	      </div>
      <div class="container footer-bottom">
        <p class="disclosure">
          <strong>Affiliate Disclosure:</strong> Some links on this website are affiliate links. If you make a purchase through these links, we may earn a commission at no additional cost to you. This helps support our work and allows us to continue providing unbiased comparisons.
        </p>
        <p>&copy; {new Date().getFullYear()} {SITE_NAME}. Data updated {dataLastUpdated}.</p>
      </div>
    </footer>

    <script src="/scripts/base-layout.js" defer></script>
    <!-- Privacy-Friendly Analytics -->
    <Analytics />
    <!-- AI Chat Assistant -->
    <ChatWidget client:idle />
  </body>
</html>
