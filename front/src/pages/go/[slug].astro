---
import redirectsData from '../../data/redirects.json';
import providersData from '../../data/providers.json';

// Build domain allowlist from known providers at build time
const ALLOWED_DOMAINS = new Set(
  providersData.providers
    .map((p) => {
      try {
        return new URL(p.website_url).hostname;
      } catch {
        return null;
      }
    })
    .filter((hostname): hostname is string => hostname !== null)
);

/**
 * Validate that a redirect URL is safe
 * - Must be a valid URL
 * - Must use HTTP/HTTPS protocol
 * - Must be to an allowlisted domain (proxy providers we know)
 */
function isSafeRedirect(url: string): boolean {
  try {
    const parsed = new URL(url);

    // Only allow HTTP/HTTPS protocols
    if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
      return false;
    }

    // Check against domain allowlist
    return ALLOWED_DOMAINS.has(parsed.hostname);
  } catch {
    // Invalid URL
    return false;
  }
}

interface RedirectEntry {
  url: string;
  affiliate: string | null;
}

interface RedirectsData {
  providers: Record<string, RedirectEntry>;
}

export function getStaticPaths() {
  const paths = providersData.providers.map((p) => ({
    // Keep /go pages available for all providers; redirects.json can be partial (affiliate overrides only).
    params: { slug: p.slug },
  }));
  return paths;
}

const { slug } = Astro.params;

// Type-safe access to redirects data
const redirects = (redirectsData as RedirectsData)?.providers ?? {};
const redirect = redirects[slug as keyof typeof redirects];
const provider = providersData.providers.find(p => p.slug === slug);

if (!provider && !redirect) {
  return Astro.redirect('/404');
}

// Determine target URL with security validation
const targetUrl = redirect?.affiliate ?? redirect?.url ?? provider?.website_url;

// Validate redirect target before allowing it
if (!targetUrl || !isSafeRedirect(targetUrl)) {
  return Astro.redirect('/404');
}

const providerName = provider?.name || slug;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecting to {providerName} | ProxyPrice</title>
  <meta name="robots" content="noindex, nofollow" />
  <meta http-equiv="refresh" content="0; url={targetUrl}" />
  <link rel="canonical" href={targetUrl} />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f8fafc;
    }
    .container {
      text-align: center;
      padding: 2rem;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1.5rem;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h1 {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    p {
      color: #94a3b8;
      font-size: 0.875rem;
    }
    a {
      color: #3b82f6;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <h1>Redirecting to {providerName}...</h1>
    <p>
      If not redirected, <a href={targetUrl}>click here</a>
    </p>
  </div>
  <script is:inline define:vars={{ targetUrl }}>
    window.location.replace(targetUrl);
  </script>
</body>
</html>
