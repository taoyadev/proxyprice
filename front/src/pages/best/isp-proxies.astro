---
import BaseLayout from "../../layouts/BaseLayout.astro";
import TrustBadge from "../../components/TrustBadge.astro";
import providersData from "../../data/providers.json";
import pricingData from "../../data/pricing.json";
import { SITE_NAME } from "../../lib/site";

const type = "isp";
const typeLabel = "ISP";

const providerById = new Map(providersData.providers.map((p) => [p.id, p]));

const top = pricingData.pricing
  .filter((p) => p.proxy_type === type && p.comparable && typeof p.min_price_per_gb === "number")
  .sort((a, b) => (a.min_price_per_gb ?? Infinity) - (b.min_price_per_gb ?? Infinity))
  .slice(0, 10)
  .map((p) => {
    const provider = providerById.get(p.provider_id);
    let bestFor: string | null = null;
    if (provider) {
      if (p.min_price_per_gb < 1) {
        bestFor = "Best value";
      } else if (provider.proxy_types.includes("residential")) {
        bestFor = "Also residential";
      } else if (provider.proxy_types.includes("mobile")) {
        bestFor = "Also mobile";
      } else if (provider.trial_offer) {
        bestFor = "Trial available";
      } else {
        bestFor = "Static sessions";
      }
    }
    return {
      provider,
      min: p.min_price_per_gb,
      url: p.price_url,
      bestFor,
    };
  })
  .filter(
    (x): x is { provider: any; min: number; url: string | null; bestFor: string | null } =>
      Boolean(x.provider) && typeof x.min === "number",
  );

const breadcrumbs = [
  { name: SITE_NAME, url: new URL("/", Astro.site).toString() },
  { name: "Best Providers", url: new URL("/best/", Astro.site).toString() },
  { name: "Best ISP Proxies", url: new URL("/best/isp-proxies/", Astro.site).toString() },
];

// Build ItemList schema for SEO
const itemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "itemListElement": top.map((item, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "item": {
      "@type": "Product",
      "name": `${item.provider.name} ISP Proxies`,
      "url": new URL(`/provider/${item.provider.slug}/`, Astro.site).toString(),
      "offers": {
        "@type": "Offer",
        "price": item.min,
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock",
      },
    },
  })),
};
---

<BaseLayout
  title={`Best ${typeLabel} Proxies`}
  description={`Best ${typeLabel.toLowerCase()} proxy providers with comparable $/GB pricing. Updated ${pricingData.last_updated}.`}
  breadcrumbs={breadcrumbs}
>
  <!-- ItemList Schema -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />

  <div class="container" style="padding: 3rem 0;">
    <header class="page-header">
      <div class="header-top">
        <div>
          <h1>Best ISP Proxies (by $/GB)</h1>
          <p class="page-subtitle">
            ISP proxies are often used for stable sessions. This list includes only providers with comparable <strong>$/GB</strong> pricing.
          </p>
        </div>
        <TrustBadge lastUpdated={pricingData.last_updated} variant="compact" />
      </div>
    </header>

    <section class="list">
      {top.length === 0 ? (
        <p class="muted">No comparable $/GB pricing found for this category yet.</p>
      ) : (
        <ol class="rank">
          {top.map((item) => (
            <li class="rank-item">
              <a class="rank-link" href={`/provider/${item.provider.slug}`}>
                <div class="rank-header">
                  <span class="name">{item.provider.name}</span>
                  {item.bestFor && <span class="best-for">{item.bestFor}</span>}
                </div>
                <span class="price">${item.min.toFixed(2)}/GB</span>
              </a>
              <div class="meta">
                <a href="/isp">Compare all ISP providers →</a>
                <a href={`/go/${item.provider.slug}`} target="_blank" rel="sponsored noopener noreferrer">Official pricing →</a>
              </div>
            </li>
          ))}
        </ol>
      )}
    </section>

    <section class="content">
      <h2>Notes</h2>
      <p class="muted">
        Many ISP products are sold per IP (non-comparable). If you want to include those, use <a href="/providers">All Providers</a> and disable “Comparable only”.
      </p>
    </section>
  </div>
</BaseLayout>

<style>
  .page-header {
    margin-bottom: 2.5rem;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
  }

  .page-subtitle {
    font-size: 1.125rem;
    color: var(--color-text-light);
    max-width: 700px;
    margin: 1rem 0 0;
  }

  @media (max-width: 768px) {
    .header-top {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  .rank { list-style: none; padding: 0; margin: 0; display: grid; gap: 0.75rem; max-width: 900px; margin-left: auto; margin-right: auto; }
  .rank-item { border: 1px solid var(--color-border); border-radius: 0.75rem; background: var(--color-bg); overflow: hidden; }
  .rank-link { display: flex; justify-content: space-between; gap: 1rem; padding: 1rem 1.25rem; text-decoration: none; color: var(--color-text); }
  .rank-link:hover { text-decoration: none; background: var(--color-bg-alt); }
  .rank-header { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .best-for { font-size: 0.75rem; padding: 0.25rem 0.5rem; background: var(--color-primary); color: white; border-radius: 0.25rem; font-weight: 500; }
  .name { font-weight: 700; }
  .price { font-family: 'SF Mono', 'Monaco', 'Consolas', monospace; color: var(--color-secondary); font-weight: 800; }
  .meta { display: flex; gap: 1rem; padding: 0.75rem 1.25rem; border-top: 1px solid var(--color-border); background: var(--color-bg-alt); font-size: 0.9rem; }
  .content { max-width: 900px; margin: 2.5rem auto 0; padding-top: 2rem; border-top: 1px solid var(--color-border); }
  .content ul { padding-left: 1.25rem; }
  .muted { color: var(--color-text-light); margin-top: 1rem; }
</style>
