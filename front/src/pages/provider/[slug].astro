---
import BaseLayout from '../../layouts/BaseLayout.astro';
import providersData from '../../data/providers.json';
import pricingData from '../../data/pricing.json';
import { SITE_NAME } from '../../lib/site';
import { getFaviconUrl } from '../../lib/favicon';

export async function getStaticPaths() {
  return providersData.providers.map(provider => ({
    params: { slug: provider.slug },
    props: { provider },
  }));
}

const { provider } = Astro.props;

// Get all pricing for this provider
const providerPricing = pricingData.pricing.filter(p => p.provider_id === provider.id);
const comparablePricing = providerPricing.filter((p) => p.comparable);
const nonComparablePricing = providerPricing.filter((p) => !p.comparable && p.has_pricing);

const breadcrumbs = [
  { name: SITE_NAME, url: new URL('/', Astro.site).toString() },
  { name: 'Providers', url: new URL('/providers', Astro.site).toString() },
  { name: provider.name, url: new URL(`/provider/${provider.slug}/`, Astro.site).toString() },
];

const formatPrice = (price: number | null) => {
  if (price === null) return 'N/A';
  return `$${price.toFixed(2)}`;
};

const getProxyTypeLabel = (type: string) => {
  const labels: Record<string, string> = {
    residential: 'Residential',
    datacenter: 'Datacenter',
    mobile: 'Mobile',
    isp: 'ISP'
  };
  return labels[type] || type;
};

const getPricingModelLabel = (model: string) => {
  const labels: Record<string, string> = {
    per_gb: '$/GB',
    per_ip: '$/IP',
    per_proxy: 'per proxy',
    per_thread: 'per thread',
    unknown: 'unknown',
  };
  return labels[model] || model;
};

const useCasesForType = (type: string) => {
  const cases: Record<string, string[]> = {
    residential: ['Web scraping at scale', 'Geo-targeted content testing', 'E-commerce price monitoring'],
    datacenter: ['High-volume automation', 'Fast API scraping', 'Cost-sensitive workloads'],
    mobile: ['Social media automation', 'Ad verification', 'Sensitive targets needing high trust'],
    isp: ['Stable sessions', 'Account management', 'Balance of speed + legitimacy'],
  };
  return cases[type] || ['General proxy usage'];
};

const topAlternatives = (type: string, count = 5) => {
  const ranked = pricingData.pricing
    .filter((p) => p.proxy_type === type && p.comparable && p.min_price_per_gb != null)
    .sort((a, b) => (a.min_price_per_gb ?? Infinity) - (b.min_price_per_gb ?? Infinity))
    .map((p) => providersData.providers.find((prov) => prov.id === p.provider_id))
    .filter((p): p is any => Boolean(p))
    .filter((p) => p.id !== provider.id);

  const unique: any[] = [];
  const seen = new Set<string>();
  for (const p of ranked) {
    if (seen.has(p.id)) continue;
    seen.add(p.id);
    unique.push(p);
    if (unique.length >= count) break;
  }
  return unique;
};
---

<BaseLayout
  title={provider.name}
  description={`Compare ${provider.name} proxy pricing across all types. Transparent pricing data updated regularly.`}
  breadcrumbs={breadcrumbs}
>
  <div class="container" style="padding: 3rem 0;">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <ol>
        <li><a href="/">Home</a></li>
        <li><a href="/providers">Providers</a></li>
        <li aria-current="page">{provider.name}</li>
      </ol>
    </nav>

    <div class="provider-header">
      <div class="provider-title">
        <img
          src={getFaviconUrl(provider.website_url, 64)}
          alt={`${provider.name} favicon`}
          class="provider-favicon"
          width="64"
          height="64"
        />
        <h1>{provider.name}</h1>
      </div>
      {provider.trial_offer && (
        <div class="trial-banner">
          <span class="trial-icon">üéÅ</span>
          <strong>Trial Offer:</strong> {provider.trial_offer}
        </div>
      )}
    </div>

    <section class="summary">
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Starting price</div>
          <div class="summary-value">
            {provider.cheapest_price_per_gb ? (
              <>
                <strong>${provider.cheapest_price_per_gb.toFixed(2)}/GB</strong>
              </>
            ) : (
              <span class="muted">N/A</span>
            )}
          </div>
          <div class="summary-sub">Comparable $/GB tiers only</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Comparable proxy types</div>
          <div class="summary-value">
            <strong>{comparablePricing.length}</strong>
          </div>
          <div class="summary-sub">with per-GB pricing</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Other pricing models</div>
          <div class="summary-value">
            <strong>{nonComparablePricing.length}</strong>
          </div>
          <div class="summary-sub">per IP / proxy / thread</div>
        </div>

        <div class="summary-card">
          <div class="summary-label">Trial</div>
          <div class="summary-value">
            {provider.trial_offer ? <strong>Available</strong> : <span class="muted">Not listed</span>}
          </div>
          <div class="summary-sub">{provider.trial_offer ? provider.trial_offer : 'See official site'}</div>
        </div>
      </div>
    </section>

    <div class="provider-grid">
      <div class="provider-main">
        <section class="pricing-section">
          <h2>Pricing by Proxy Type</h2>

	          {providerPricing.map(pricing => (
	            <div class="pricing-card">
	              <div class="pricing-header">
	                <h3>{getProxyTypeLabel(pricing.proxy_type)}</h3>
	                {pricing.comparable && (
	                  <div class="price-range">
	                    {formatPrice(pricing.min_price_per_gb)} - {formatPrice(pricing.max_price_per_gb)}/GB
	                  </div>
	                )}
	              </div>

	              {pricing.tiers && pricing.tiers.length > 0 ? (
	                pricing.comparable ? (
	                  <div class="tiers-table">
	                    <table>
	                      <thead>
	                        <tr>
	                          <th>Volume</th>
	                          <th>$/GB</th>
	                          <th>Total</th>
	                        </tr>
	                      </thead>
	                      <tbody>
	                        {pricing.tiers
	                          .filter(t => (t as any).pricing_model === 'per_gb')
	                          .slice(0, 10)
	                          .map(tier => (
	                            <tr>
	                              <td>{(tier as any).gb} GB</td>
	                              <td>{formatPrice((tier as any).price_per_gb)}</td>
	                              <td>${(tier as any).total?.toFixed(2)}</td>
	                            </tr>
	                          ))}
	                      </tbody>
	                    </table>
	                    {pricing.tiers.filter(t => (t as any).pricing_model === 'per_gb').length === 0 && (
	                      <p class="no-pricing">Comparable pricing is marked for this record, but no per-GB tiers were parsed.</p>
	                    )}
	                    {pricing.tiers.filter(t => (t as any).pricing_model === 'per_gb').length > 10 && (
	                      <p class="more-tiers">+{pricing.tiers.filter(t => (t as any).pricing_model === 'per_gb').length - 10} more tiers</p>
	                    )}
	                  </div>
	                ) : (
	                  <div class="non-comparable">
	                    <p class="non-comparable-note">
	                      This pricing is <strong>non-comparable</strong> ({getPricingModelLabel((pricing as any).pricing_model)}). We don‚Äôt convert it to $/GB.
	                    </p>

	                    {(pricing as any).pricing_model === 'per_ip' && (
	                      <div class="tiers-table">
	                        <table>
	                          <thead>
	                            <tr>
	                              <th>IPs</th>
	                              <th>$/IP</th>
	                              <th>Total</th>
	                            </tr>
	                          </thead>
	                          <tbody>
	                            {pricing.tiers
	                              .filter(t => (t as any).pricing_model === 'per_ip')
	                              .slice(0, 10)
	                              .map(tier => (
	                                <tr>
	                                  <td>{(tier as any).ips}</td>
	                                  <td>{formatPrice((tier as any).price_per_ip)}</td>
	                                  <td>${(tier as any).total?.toFixed(2)}</td>
	                                </tr>
	                              ))}
	                          </tbody>
	                        </table>
	                      </div>
	                    )}

	                    {(pricing as any).pricing_model === 'per_proxy' && (
	                      <div class="tiers-table">
	                        <table>
	                          <thead>
	                            <tr>
	                              <th>Proxies</th>
	                              <th>Total</th>
	                            </tr>
	                          </thead>
	                          <tbody>
	                            {pricing.tiers
	                              .filter(t => (t as any).pricing_model === 'per_proxy')
	                              .slice(0, 10)
	                              .map(tier => (
	                                <tr>
	                                  <td>{(tier as any).proxies}</td>
	                                  <td>${(tier as any).total?.toFixed(2)}</td>
	                                </tr>
	                              ))}
	                          </tbody>
	                        </table>
	                      </div>
	                    )}

	                    {(pricing as any).pricing_model === 'per_thread' && (
	                      <div class="tiers-table">
	                        <table>
	                          <thead>
	                            <tr>
	                              <th>Threads</th>
	                              <th>Total</th>
	                            </tr>
	                          </thead>
	                          <tbody>
	                            {pricing.tiers
	                              .filter(t => (t as any).pricing_model === 'per_thread')
	                              .slice(0, 10)
	                              .map(tier => (
	                                <tr>
	                                  <td>{(tier as any).threads}</td>
	                                  <td>${(tier as any).total?.toFixed(2)}</td>
	                                </tr>
	                              ))}
	                          </tbody>
	                        </table>
	                      </div>
	                    )}

	                    {(pricing as any).pricing_model !== 'per_ip' &&
	                      (pricing as any).pricing_model !== 'per_proxy' &&
	                      (pricing as any).pricing_model !== 'per_thread' && (
	                        <p class="no-pricing">Pricing tiers were detected but could not be normalized for comparison.</p>
	                      )}
	                  </div>
	                )
	              ) : (
	                <p class="no-pricing">Pricing data not available.</p>
	              )}

	              {pricing.price_url && (
	                <a href={pricing.price_url} target="_blank" rel="noopener noreferrer" class="view-pricing-btn">
	                  View Full Pricing ‚Üí
	                </a>
	              )}
	            </div>
	          ))}

          {providerPricing.length === 0 && (
            <p class="no-data">No pricing data available for this provider yet.</p>
          )}
        </section>

        <section class="content-section">
          <h2>Best for</h2>
          <div class="use-cases">
            {(provider.proxy_types || []).filter((t) => t !== 'other').map((type) => (
              <div class="use-case-card">
                <h3>{getProxyTypeLabel(type)}</h3>
                <ul>
                  {useCasesForType(type).map((c) => (
                    <li>{c}</li>
                  ))}
                </ul>
                <a class="inline-link" href={`/${type}`}>Compare {getProxyTypeLabel(type)} pricing ‚Üí</a>
              </div>
            ))}
            {(provider.proxy_types || []).length === 0 && (
              <p class="muted">No proxy type metadata available for this provider.</p>
            )}
          </div>
        </section>

        <section class="content-section">
          <h2>Alternatives</h2>
          <p class="muted">
            These alternatives are selected from providers with comparable <strong>$/GB</strong> pricing for the same proxy type.
          </p>

          <div class="alternatives">
            {(provider.proxy_types || []).filter((t) => t !== 'other').map((type) => (
              <div class="alt-group">
                <h3>Top {getProxyTypeLabel(type)} alternatives</h3>
                <div class="alt-list">
                  {topAlternatives(type).map((p) => (
                    <a class="alt-item" href={`/provider/${p.slug}`}>
                      <div class="alt-info">
                        <img
                          src={getFaviconUrl(p.website_url, 24)}
                          alt={`${p.name} favicon`}
                          class="alt-favicon"
                          width="24"
                          height="24"
                        />
                        <span class="alt-name">{p.name}</span>
                      </div>
                      {p.cheapest_price_per_gb ? (
                        <span class="alt-price">${p.cheapest_price_per_gb.toFixed(2)}/GB</span>
                      ) : (
                        <span class="alt-price muted">N/A</span>
                      )}
                    </a>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>

        <section class="content-section">
          <h2>FAQ</h2>
          <div class="faq">
            <details>
              <summary>What does ‚Äúcomparable‚Äù mean?</summary>
              <p>
                Comparable pricing means the provider‚Äôs tier can be expressed as a per-GB rate (e.g. <code>$X/GB</code>),
                or a plan that can be converted to <strong>$/GB</strong>. Other models (per IP / proxy / thread) are not converted.
              </p>
            </details>
            <details>
              <summary>Why do some rows show N/A for $/GB?</summary>
              <p>
                Some products are priced per IP, per proxy, or per thread. Without a bandwidth allowance, converting to $/GB would be misleading.
              </p>
            </details>
            <details>
              <summary>Does the calculator include discounts or taxes?</summary>
              <p>No. The calculator estimates cost using public list pricing tiers. Always confirm final pricing on the provider‚Äôs site.</p>
            </details>
            <details>
              <summary>How often is pricing updated?</summary>
              <p>See the ‚ÄúData updated‚Äù date in the footer and our <a href="/methodology">methodology</a> page for details.</p>
            </details>
          </div>
        </section>
      </div>

      <aside class="provider-sidebar">
        <div class="provider-info-card">
          <h3>Provider Information</h3>
          <dl>
            <dt>Website</dt>
            <dd><a href={provider.website_url} target="_blank" rel="noopener noreferrer">{provider.website_url}</a></dd>

            {provider.proxy_types && provider.proxy_types.length > 0 && (
              <>
                <dt>Proxy Types</dt>
                <dd>
                  <div class="proxy-types-list">
                    {provider.proxy_types.map(type => (
                      <span class={`proxy-badge ${type}`}>{getProxyTypeLabel(type)}</span>
                    ))}
                  </div>
                </dd>
              </>
            )}

            {provider.cheapest_price_per_gb && (
              <>
                <dt>Starting Price</dt>
                <dd><strong>${provider.cheapest_price_per_gb.toFixed(2)}/GB</strong></dd>
              </>
            )}
          </dl>

          <a href={provider.website_url} target="_blank" rel="noopener noreferrer" class="cta-button">
            Visit {provider.name} ‚Üí
          </a>
        </div>

        <div class="provider-info-card" style="margin-top: 1rem;">
          <h3>Quick Links</h3>
          <ul class="side-links">
            <li><a href="/calculator">Price Calculator</a></li>
            <li><a href="/providers">All Providers</a></li>
            <li><a href="/methodology">Methodology</a></li>
          </ul>
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>

<style>
	  .provider-header {
	    text-align: center;
	    margin-bottom: 3rem;
	  }

	  .provider-title {
	    display: flex;
	    align-items: center;
	    justify-content: center;
	    gap: 1rem;
	    margin-bottom: 1rem;
	  }

	  .provider-favicon {
	    border-radius: 0.5rem;
	    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	  }

	  .breadcrumbs ol {
	    list-style: none;
	    display: flex;
	    flex-wrap: wrap;
	    gap: 0.5rem;
	    align-items: center;
	    padding: 0;
	    margin: 0 0 1rem;
	    color: var(--color-text-light);
	    font-size: 0.875rem;
	  }

	  .breadcrumbs li::after {
	    content: '/';
	    margin-left: 0.5rem;
	    opacity: 0.6;
	  }

	  .breadcrumbs li:last-child::after {
	    content: '';
	    margin: 0;
	  }

	  .breadcrumbs a {
	    color: var(--color-text-light);
	  }

	  .breadcrumbs a:hover {
	    color: var(--color-primary);
	    text-decoration: none;
	  }

  .provider-header h1 {
    margin-bottom: 1rem;
  }

	  .trial-banner {
	    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border-radius: 0.5rem;
    font-size: 0.875rem;
  }

  .trial-icon {
    font-size: 1.25rem;
  }

	  .provider-grid {
	    display: grid;
	    grid-template-columns: 1fr 300px;
	    gap: 2rem;
	  }

	  .summary {
	    margin-bottom: 2rem;
	  }

	  .summary-grid {
	    display: grid;
	    grid-template-columns: repeat(4, minmax(0, 1fr));
	    gap: 1rem;
	  }

	  .summary-card {
	    border: 1px solid var(--color-border);
	    background: var(--color-bg);
	    border-radius: 0.75rem;
	    padding: 1.25rem;
	  }

	  .summary-label {
	    color: var(--color-text-light);
	    font-size: 0.75rem;
	    font-weight: 650;
	    text-transform: uppercase;
	    letter-spacing: 0.06em;
	  }

	  .summary-value {
	    margin-top: 0.5rem;
	    font-size: 1.25rem;
	  }

	  .summary-sub {
	    margin-top: 0.35rem;
	    color: var(--color-text-light);
	    font-size: 0.875rem;
	  }

  .pricing-section h2 {
    margin-bottom: 2rem;
  }

  .pricing-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .pricing-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .price-range {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-secondary);
  }

  .tiers-table {
    overflow-x: auto;
  }

  .tiers-table table {
    width: 100%;
    border-collapse: collapse;
  }

  .tiers-table th,
  .tiers-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .tiers-table th {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--color-text-light);
  }

  .more-tiers {
    margin-top: 1rem;
    text-align: center;
    color: var(--color-text-light);
    font-size: 0.875rem;
  }

  .view-pricing-btn {
    display: inline-block;
    margin-top: 1.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--color-primary);
    color: white;
    border-radius: 0.375rem;
    font-weight: 600;
    text-decoration: none;
  }

  .view-pricing-btn:hover {
    background: var(--color-primary-dark);
  }

	  .no-pricing,
	  .no-data {
	    color: var(--color-text-light);
	    font-style: italic;
	  }

	  .non-comparable-note {
	    margin-bottom: 1rem;
	    padding: 0.75rem 1rem;
	    background: var(--color-bg-alt);
	    border: 1px solid var(--color-border);
	    border-radius: 0.5rem;
	    color: var(--color-text);
	  }

	  .content-section {
	    margin-top: 3rem;
	  }

	  .use-cases {
	    display: grid;
	    grid-template-columns: repeat(2, minmax(0, 1fr));
	    gap: 1rem;
	  }

	  .use-case-card {
	    border: 1px solid var(--color-border);
	    background: var(--color-bg);
	    border-radius: 0.75rem;
	    padding: 1.25rem;
	  }

	  .use-case-card h3 {
	    margin-bottom: 0.75rem;
	  }

	  .use-case-card ul {
	    padding-left: 1.25rem;
	    margin-bottom: 0.75rem;
	  }

	  .inline-link {
	    display: inline-block;
	    margin-top: 0.25rem;
	    font-weight: 600;
	    color: var(--color-primary);
	  }

	  .alternatives {
	    display: grid;
	    gap: 1.25rem;
	  }

	  .alt-group h3 {
	    margin-bottom: 0.75rem;
	  }

	  .alt-list {
	    display: grid;
	    gap: 0.5rem;
	  }

	  .alt-item {
	    display: flex;
	    justify-content: space-between;
	    align-items: center;
	    gap: 1rem;
	    padding: 0.75rem 1rem;
	    border: 1px solid var(--color-border);
	    border-radius: 0.75rem;
	    background: var(--color-bg);
	    color: var(--color-text);
	    text-decoration: none;
	  }

	  .alt-item:hover {
	    border-color: var(--color-primary);
	    text-decoration: none;
	  }

	  .alt-info {
	    display: flex;
	    align-items: center;
	    gap: 0.75rem;
	  }

	  .alt-favicon {
	    border-radius: 0.375rem;
	    flex-shrink: 0;
	  }

	  .alt-name {
	    font-weight: 650;
	  }

	  .alt-price {
	    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
	    color: var(--color-text-light);
	    font-size: 0.875rem;
	  }

	  .faq details {
	    border: 1px solid var(--color-border);
	    border-radius: 0.75rem;
	    padding: 0.75rem 1rem;
	    background: var(--color-bg);
	    margin-bottom: 0.75rem;
	  }

	  .faq summary {
	    font-weight: 650;
	    cursor: pointer;
	  }

	  .faq p {
	    margin-top: 0.75rem;
	    color: var(--color-text-light);
	  }

	  .side-links {
	    list-style: none;
	    padding: 0;
	  }

	  .side-links li {
	    margin-bottom: 0.5rem;
	  }

	  .muted {
	    color: var(--color-text-light);
	  }

  .provider-sidebar {
    position: sticky;
    top: 100px;
    height: fit-content;
  }

  .provider-info-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    padding: 1.5rem;
  }

  .provider-info-card h3 {
    margin-bottom: 1.5rem;
  }

  .provider-info-card dl {
    margin-bottom: 1.5rem;
  }

  .provider-info-card dt {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-light);
    margin-top: 1rem;
  }

  .provider-info-card dd {
    margin-top: 0.25rem;
  }

  .provider-info-card a {
    word-break: break-all;
  }

  .proxy-types-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .proxy-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .proxy-badge.residential {
    background: #dbeafe;
    color: #1e40af;
  }

  .proxy-badge.datacenter {
    background: #e0e7ff;
    color: #4338ca;
  }

  .proxy-badge.mobile {
    background: #fce7f3;
    color: #9f1239;
  }

  .proxy-badge.isp {
    background: #d1fae5;
    color: #065f46;
  }

  .cta-button {
    display: block;
    width: 100%;
    padding: 0.875rem;
    background: var(--color-primary);
    color: white;
    border-radius: 0.5rem;
    font-weight: 600;
    text-align: center;
    text-decoration: none;
  }

  .cta-button:hover {
    background: var(--color-primary-dark);
  }

	  @media (max-width: 768px) {
	    .summary-grid {
	      grid-template-columns: repeat(2, minmax(0, 1fr));
	    }

	    .use-cases {
	      grid-template-columns: 1fr;
	    }

	    .provider-grid {
	      grid-template-columns: 1fr;
	    }

    .provider-sidebar {
      position: static;
    }

    .pricing-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
  }
</style>
